
<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <link type="text/css" rel="stylesheet" href="css/style.css"/>
    <style type="text/css">

text {
  font-size: 11px;
  pointer-events: none;
}

text.parent {
  fill: #1f77b4;
}

circle {
  fill: #ccc;
  stroke: #999;
  pointer-events: all;
}

circle.parent {
  fill: #1f77b4;
  fill-opacity: .1;
  stroke: steelblue;
}

circle.parent:hover {
  stroke: #ff7f0e;
  stroke-width: .5px;
}

circle.child {
  pointer-events: none;
}

    </style>
  </head>
  <body>
    <h2>
      Flare code size<br>
      circle packing
    </h2>
    <script type="text/javascript" src="js/d3.js"></script>
    <script type="text/javascript" src="js/d3.layout.js"></script>
    <script type="text/javascript">

//to be used later
//var url = "https://ldcidp7.wdf.sap.corp:44370/sap/opu/odata/sap/ZSM_SYS_MON_DEMO1_SRV/Overview?$format=json&search=SD7~ABAP|DP7~ABAP";
//d3.xhr(url[, mimeType][, callback])

var w = 1280,
    h = 800,
    r = 720,
    x = d3.scale.linear().range([0, r]),
    y = d3.scale.linear().range([0, r]),
    node,
    root;

var pack = d3.layout.pack()
    .size([r, r])
    .value(function(d) { return d.size; })

var vis = d3.select("body").insert("svg:svg", "h2")
    .attr("width", w)
    .attr("height", h)
  .append("svg:g")
    .attr("transform", "translate(" + (w - r) / 2 + "," + (h - r) / 2 + ")");

d3.json("service.json", function(data) {
  //node = root = data;
  node = root = data.d.results;
  //console.log(root);

  //d3 nesting?
  var newData = {"name":"root", "children":[{"name":"Systems", "children":[]}]};
  var count = 0;

// ===============TYPE SORTING =================
  //sorting by type for testing
  // node.sort(function(a, b){
  //    var nameA=a.ArchType.toLowerCase(), nameB=b.ArchType.toLowerCase()
  //    if (nameA < nameB) //sort string ascending
  //     return -1 
  //    if (nameA > nameB)
  //     return 1
  //    return 0 //default return value (no sorting)
  // });

  // //System Type grouping
  // node.forEach(function(d){

  //       if (newData.children[0].children[count] == undefined ) {

  //           if (count !== 0) {
  //             if (newData.children[0].children[count - 1].name !== d.ArchType) {
  //                 newData.children[0].children.push({"name":d.ArchType, "children":[]})
  //                 count = count + 1;
  //             }
  //           }
  //           else{
  //             //create a new children first
  //             newData.children[0].children.push({"name":d.ArchType, "children":[]})
  //             count = count + 1;
  //           }
  //       }

  //       if (newData.children[0].children[count - 1].name !== d.ArchType) {
  //             newData.children[0].children[count - 1].children = [{"name": d.SystemName,  "size":4000}]
  //       }
  //       else{
  //         newData.children[0].children[count - 1].children.push({"name":d.SystemName, "size":4000})
  //       }
  // })

// ===============TYPE SORTING =================

// ===============SYSTEM NAME SORTING =================
  //sorting by type for testing
  node.sort(function(a, b){
     var nameA=a.Extsid.toLowerCase(), nameB=b.Extsid.toLowerCase()
     if (nameA < nameB) //sort string ascending
      return -1 
     if (nameA > nameB)
      return 1
     return 0 //default return value (no sorting)
  });

  //System Type grouping
  node.forEach(function(d){

        if (newData.children[0].children[count] == undefined ) {

            if (count !== 0) {
              if (newData.children[0].children[count - 1].name.charAt(0) !== d.Extsid.charAt(0)) {
                  newData.children[0].children.push({"name":d.Extsid.charAt(0), "children":[]})
                  count = count + 1;
              }
            }
            else{
              //create a new children first
              newData.children[0].children.push({"name":d.Extsid.charAt(0), "children":[]})
              count = count + 1;
            }
        }

        if (newData.children[0].children[count - 1].name.charAt(0) !== d.Extsid.charAt(0)) {
              newData.children[0].children[count - 1].children = [{"name": d.SystemName,  "size":4000}]
        }
        else{
          newData.children[0].children[count - 1].children.push({"name":d.SystemName, "size":4000})
        }
  })

// ===============SYSTEM NAME SORTING =================

// ===============BETA TESTING=================
  // var count = 0;

  //   node.forEach(function(d){
    
  //       //d["size"] = 1000;
  //       //d["name"] = d.SystemName;
  //       //delete d.__metadata;
  //       //alert(newData.children["children"]);
  //       count = count + 1;
  //       if (newData.children[0].children == undefined) {
  //         newData.children[0].children = [{"name": d.SystemName,  "size":4000}]
  //       }
  //       else{
  //         newData.children[0].children.push({"name":d.SystemName, "size":4000})
  //       }
  //   })

  //   node.forEach(function(d){
    
  //       if (newData.children[1] == undefined) {
  //         //newData.children[1].children = {"name": d.SystemName,  "size":4000}
  //         //create a new children first
  //         newData.children.push({"name":"systems2", "children":[]})
  //       }

  //       if (newData.children[1].children == undefined){
  //         newData.children[1].children = [{"name": d.SystemName,  "size":4000}]
  //       }
  //       else{
  //         newData.children[1].children.push({"name":d.SystemName, "size":4000})
  //       }
  //       count = count + 1;
  //   })
  // ===============BETA TESTING =================

  node = root = newData;
  //alert(JSON.stringify(newData));

  var nodes = pack.nodes(newData);

  vis.selectAll("circle")
      .data(nodes)
    .enter().append("svg:circle")
      .attr("class", function(d) { return d.children ? "parent" : "child"; })
      .attr("cx", function(d) { return d.x; })
      .attr("cy", function(d) { return d.y; })
      .attr("r", function(d) { return d.r; })
      .on("click", function(d) { return zoom(node == d ? root : d); });

  vis.selectAll("text")
      .data(nodes)
    .enter().append("svg:text")
      .attr("class", function(d) { return d.children ? "parent" : "child"; })
      .attr("x", function(d) { return d.children ? d.x - d.r*1/2 : d.x; })
      .attr("y", function(d) { return d.children ? d.y - d.r*4/5 : d.y; })
      .attr("dy", "1em")
      .attr("text-anchor", "middle")
      //.attr("font-size", "200%")
      .style("opacity", function(d) { return d.r > 20 ? 1 : 0; })
      .text(function(d) { return (node==d) ? "" : d.name; });

  d3.select(window).on("click", function() { zoom(root); });
});

function zoom(d, i) {
  var k = r / d.r / 2;
  x.domain([d.x - d.r, d.x + d.r]);
  y.domain([d.y - d.r, d.y + d.r]);

  var t = vis.transition()
      .duration(d3.event.altKey ? 7500 : 750);

  t.selectAll("circle")
      .attr("cx", function(d) { return x(d.x); })
      .attr("cy", function(d) { return y(d.y); })
      .attr("r", function(d) { return k * d.r; });

  t.selectAll("text")
      .attr("x", function(d) { return d.children ? x(d.x - d.r*1/2): x(d.x); })
      .attr("y", function(d) { return d.children ? y(d.y - d.r*4/5) : y(d.y); })
      .style("opacity", function(d) { return k * d.r > 20 ? 1 : 0; });

  node = d;
  d3.event.stopPropagation();
}

    </script>
  </body>
</html>
